# Техническое задание: Развитие функционала привычек

## Задача 1: Исправление ошибки 406 при чекине привычки

### Описание
При попытке отметить привычку выполненной (или при проверке её статуса) возникает ошибка `406 (Not Acceptable)`. Это происходит из-за использования метода `.single()` при запросе записи, которая может отсутствовать.

### Что сделать
1. В файле `src/features/habits/api/useHabits.ts` в функции `toggleHabit` изменить запрос проверки существования записи:
   - Было: `.select('*')...single()`
   - Стало: `.select('*')...maybeSingle()`
2. Убедиться, что логика создания новой записи (`if (!existing)`) корректно отрабатывает при `null` результате.

---

## Задача 2: Редактирование привычки

### Описание
Реализовать возможность изменения основных параметров привычки. Изменения применяются "на месте" и обновляют отображение привычки во всем приложении (история изменений не хранится).

### Что сделать
1. **API / Frontend Logic:**
   - Использовать существующую мутацию `updateHabit` (или доработать её при необходимости).
   - Поля для редактирования:
     - Название
     - Описание
     - Иконка
     - Цвет
   - Настройки расписания (частота, дни) — **не редактируются** (согласно текущему UI, если нужно - уточнить, но пока оставляем как есть).

2. **Интерфейс:**
   - На странице/модалке привычки добавить кнопку "Редактировать" (например, иконка карандаша).
   - Открывать форму, аналогичную созданию (`CreateHabitForm`), но предзаполненную текущими данными.
   - Заголовок формы: "Редактирование привычки".
   - Кнопка сохранения: "Сохранить изменения".

3. **Предупреждение:**
   - При сохранении (или перед открытием формы) показывать предупреждение: "Изменение названия или иконки обновит отображение привычки за весь период статистики".

---

## Задача 3: Удаление привычки

### Описание
Реализовать "мягкое" удаление привычки. Привычка помечается как удаленная и скрывается из всех интерфейсов, но остается в БД.

### Что сделать
1. **API:**
   - Использовать метод `archiveHabit` (переименовать в `deleteHabit` для ясности или использовать как есть, устанавливая `status = 'deleted'` и `deleted_at = NOW()`).
   - Убедиться, что RLS политики или фильтры на клиенте исключают привычки со статусом `deleted`.

2. **Интерфейс:**
   - В меню действий привычки добавить пункт "Удалить".
   - Подтверждение удаления (alert/dialog): "Вы уверены? Привычка исчезнет из статистики и прогресса".

3. **Влияние на систему:**
   - **Главная (Сегодня):** Привычка пропадает.
   - **Мои привычки:** Привычка пропадает.
   - **Статистика/Прогресс:** Привычка пропадает из расчетов стриков и общего прогресса (даже за прошлые дни).

---

## Задача 4: Расширенные параметры привычки (Values & Comments)

### Описание
Добавить возможность трекать не только факт выполнения ("сделано"), но и количественные показатели и комментарии. Набор параметров настраивается индивидуально для каждой привычки.

### Требования к данным (БД)

#### 1. Таблица `habits` (Настройки)
Добавить флаги (boolean) для включения отслеживания параметров:
- `track_notes` (Комментарии)
- `track_weight` (Вес, г)
- `track_volume` (Объем, мл)
- `track_count` (Количество, шт)
- `track_duration` (Длительность, мин)

#### 2. Таблица `habit_records` (Данные)
Добавить поля для хранения значений:
- `note` (TEXT) — комментарий
- `value_weight` (INTEGER/NUMERIC) — вес в граммах
- `value_volume` (INTEGER/NUMERIC) — объем в мл
- `value_count` (INTEGER/NUMERIC) — количество в штуках
- `value_duration` (INTEGER/NUMERIC) — длительность в минутах

### Интерфейс

#### 1. Создание/Редактирование привычки
- Добавить блок "Параметры отслеживания" (Toggle/Switch переключатели):
  - [ ] Комментарий
  - [ ] Вес (г)
  - [ ] Объем (мл)
  - [ ] Количество (шт)
  - [ ] Длительность (мин)
- Можно выбрать несколько параметров одновременно.

#### 2. Отметка выполнения (Внутри дня)
- При клике на привычку (или через действие "Подробнее") открывается детальный вид дня.
- Если привычка выполнена (или при выполнении), показывать поля для ввода включенных параметров:
  - **Комментарий:** Textarea.
  - **Числовые поля:** Input type="number" с соответствующими суффиксами (г, мл, шт, мин).
- Данные сохраняются в таблицу `habit_records`.
- Поле даты выполнения проставляется автоматически текущей датой (или выбранной датой в календаре).

### Логика работы
- Если параметр был включен, данные записаны, а потом параметр выключили: данные в БД остаются, но в интерфейсе не отображаются.
- Если параметр включили обратно: старые данные снова видны.
- Уникальность услуг (привычек) сохраняется в рамках пользователя.

---

## Критерии приемки (Gherkin)

```gherkin
Сценарий: Исправление ошибки 406
  Дано привычка "Йога" создана
  И записи за сегодня нет
  Когда я нажимаю "Выполнить"
  Тогда запись создается без ошибок сети
  И статус меняется на "Выполнено"

Сценарий: Редактирование привычки
  Дано привычка "Бег" с цветом "Красный"
  Когда я меняю название на "Прогулка" и цвет на "Зеленый"
  Тогда в списке привычек я вижу "Прогулка" зеленого цвета
  И в статистике за прошлую неделю тоже отображается "Прогулка"

Сценарий: Удаление привычки
  Дано у меня есть привычка "Вредная еда"
  Когда я удаляю эту привычку
  Тогда она исчезает из списка "Сегодня"
  И она исчезает из раздела "Мои привычки"
  И она перестает учитываться в общем проценте выполнения за прошлые дни

Сценарий: Создание привычки с параметрами
  Когда я создаю привычку "Вода"
  И включаю трекинг "Объем (мл)" и "Комментарий"
  Тогда привычка создается с соответствующими флагами

Сценарий: Заполнение параметров дня
  Дано привычка "Вода" с трекингом объема
  Когда я открываю карточку привычки за сегодня
  И ввожу "2000" в поле "Объем" и сохраняю
  Тогда значение 2000 мл сохраняется в истории за этот день
```

## План работ
1. Внести изменения в БД (миграция).
2. Исправить ошибку 406 в `useHabits.ts`.
3. Обновить типы TypeScript.
4. Доработать форму создания/редактирования (`CreateHabitForm`).
5. Реализовать логику удаления.
6. Обновить компонент карточки привычки для ввода значений.
