# Поддержка мульти-девайс авторизации — Бизнес-требования

**Дата:** 2026-01-13
**Автор:** Trae AI

---

## Связанные документы
- **Контекст проекта:** Project_Context.md

## История изменений
- 2026-01-13 - Документ создан

---

## 1. Проблема

### Пользователь
Все пользователи приложения (Guests, Residents), использующие более одного устройства (например, телефон + ноутбук).

### Jobs To Be Done
**Когда** я использую приложение на разных устройствах (телефон в дороге, ноутбук дома),  
**Пользователь хочет** оставаться авторизованным на всех устройствах одновременно,  
**Чтобы** не тратить время на повторный вход через Telegram каждый раз при смене устройства.

### Текущее состояние
Сейчас авторизация на новом устройстве (например, ПК) приводит к "разлогину" на предыдущем устройстве (телефон). Это создает трение и раздражение, так как вход требует действий в Telegram.

---

## 2. Бизнес-цели и метрики

### Главная цель
Обеспечить бесшовный опыт использования приложения на нескольких устройствах, устранив принудительные разлогины.

### Метрики успеха

**Первичная метрика:**
- Количество жалоб на "вылетающую" авторизацию (снижение до 0).

**Вторичные метрики:**
- Retention Rate (удержание пользователей, так как барьер входа снижается).
- DAU (Daily Active Users) — пользователи чаще заходят, если не нужно логиниться.

### Нефункциональные требования
- **Безопасность:** Поддержка нескольких сессий не должна компрометировать безопасность аккаунта. Возможность удаленного выхода (опционально в будущем).
- **Производительность:** Проверка сессии не должна замедлять старт приложения.

### Не является целью
- Реализация панели управления сессиями ("Где я залогинен") — это отдельная фича.
- Изменение способа входа (остается через Telegram).

---

## 3. Сценарии использования

### Основной сценарий (Happy Path)

**Актор:** Пользователь  
**Цель:** Использовать приложение на двух устройствах

**Шаги:**
1. Пользователь авторизуется на **Устройстве А** (Телефон).
2. Система создает сессию для Устройства А.
3. Пользователь авторизуется на **Устройстве Б** (ПК).
4. Система создает сессию для Устройства Б.
5. Пользователь возвращается к **Устройству А**.
6. **Результат:** Пользователь все еще авторизован на Устройстве А и может продолжать работу.

### Error cases (граничные случаи)

**Ситуация 1:** Смена IP адреса или сети
**Ожидаемое поведение:** Сессия должна сохраняться (если это не нарушает политики безопасности Supabase).

**Ситуация 2:** Истечение срока действия Refresh Token
**Ожидаемое поведение:** Пользователь разлогинивается только на том устройстве, где токен истек.

---

## 4. Ограничения

### Технические ограничения
- Используем Supabase Auth (GoTrue).
- Логика авторизации завязана на Edge Functions (`telegram-auth`, `generate-auth-token`).
- Текущая реализация использует общий "пароль" (Bot Token) для всех пользователей, что является техническим долгом, но его изменение может быть за рамками этой задачи (хотя желательно).

### Бизнесовые ограничения
- Нет жесткого дедлайна, но проблема критична для UX.

### Риски и допущения
- **Риск:** Настройки Supabase Project могут принудительно ограничивать кол-во сессий.
- **Допущение:** Мы можем изменить логику Edge Functions для более корректной работы с сессиями.

---

## 5. Приоритеты

### Must Have (критично для релиза)
- [ ] Поддержка одновременной работы минимум на 2-х устройствах.
- [ ] Исправление логики в Edge Functions, которая может приводить к инвалидации токенов.

### Should Have (важно, но можно отложить)
- [ ] Улучшение безопасности (уход от общего пароля).

### Nice to Have (если успеем)
- [ ] UI для просмотра активных сессий.

---

## 6. Следующие шаги

- [ ] Проектирование решения (Design.md)
- [ ] Написание технических требований (Technical_Specification.md)
