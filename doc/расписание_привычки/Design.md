# Habiter — Логическое проектирование

**Дата:** 2026-01-10
**Режим:** Scale-up

---

## Связанные документы
- **Бизнес-требования:** [Business_Requirements.md](Business_Requirements.md)
- **Контекст проекта:** [Project_Context.md](Project_Context.md)

## История изменений
- 2026-01-10 - Документ создан

---

## 1. Контекст задачи

### Что делаем
Реализуем возможность выбора конкретных дней недели для выполнения привычки (например, только Пн, Ср, Пт).

### Что есть сейчас
- В базе данных (таблица `habits`) уже есть поля `frequency` (enum) и `repeatDays` (array[int]), но они не используются в UI.
- Все привычки считаются ежедневными.
- Главный экран отображает все активные привычки без фильтрации по дню.

### Что меняем
- **UI создания/редактирования:** Добавляем контрол выбора дней недели.
- **Главный экран:** Фильтруем список привычек — показываем только те, которые запланированы на выбранную дату (или если `frequency = daily`).
- **Статистика:** Учитываем расписание при расчете прогресса.

---

## 2. Варианты решения

### Вариант А: Жесткая фильтрация (Выбранное решение)

**Логика:**
- Привычка имеет настройку: "Каждый день" или "Конкретные дни".
- Если "Конкретные дни", то массив `repeatDays` хранит индексы дней (1-7, где 1=Понедельник).
- На главном экране привычка показывается ТОЛЬКО если текущий день совпадает с расписанием.
- Исторические записи (`habit_records`) остаются как есть, даже если расписание изменилось.

**UI/UX:**
- В форме переключатель (Segmented Control): "Каждый день" | "По дням".
- При выборе "По дням" — ряд из 7 кнопок (Пн..Вс).
- На главном экране привычка просто исчезает в "нерабочие" дни.

**Граничные случаи:**
- Если изменить расписание (убрать Пн), а в прошлый Пн была отметка выполнения — отметка остается в истории, но в будущем Пн привычка не появится.

**Плюсы:**
- Простота реализации (используем существующие поля).
- Понятное поведение для пользователя.

**Минусы:**
- Нельзя посмотреть историю изменений расписания (нет версионности настроек).

---

## 3. Рекомендация

### Выбираем: **Вариант А**

**Почему:**
- Полностью покрывает бизнес-требования.
- Использует уже заложенную в БД схему (`frequency`, `repeatDays`).
- Версионность расписания (сложный вариант) не требуется на текущем этапе (Scale-up режим), достаточно текущего снапшота настроек.

**Trade-offs:**
- При изменении расписания мы "забываем", какое расписание было раньше. Статистика за прошлые периоды будет рассчитываться корректно по факту наличия записей (`habit_records`), но "пропуски" в прошлом могут интерпретироваться неверно, если мы захотим пересчитать их по *текущему* расписанию.
- **Решение:** Для статистики считаем так: если есть запись выполнения — это успех. Пропуски в прошлом считаем по *текущему* расписанию (допущение).

---

## 4. Что меняем в системе

### CRM (Admin Panel) — N/A
Изменений нет, так как админки нет.

### Мобильное приложение (Telegram Mini App)

**1. Форма создания/редактирования привычки (`CreateHabitForm.tsx`)**
- Добавить поле `frequency` (radio/tabs: 'daily', 'specific_days').
- Добавить компонент `WeekDaySelector` (7 кнопок).
- Логика:
  - При переключении на 'daily' -> `repeatDays` очищается или игнорируется.
  - При переключении на 'specific_days' -> показываем селектор.
  - Валидация: если 'specific_days', массив `repeatDays` не должен быть пустым.

**2. Главный экран (`TodayProgress` / Список привычек)**
- Логика выборки (`useHabits` hook или селектор):
  - Получаем `selectedDate` (из календаря).
  - Фильтруем привычки:
    - Если `frequency === 'daily'` -> показывать.
    - Если `frequency === 'specific_days'` -> проверить, входит ли `getDay(selectedDate)` в `repeatDays`.

**3. Хук `useHabits` / `useHabitRecords`**
- Убедиться, что `repeatDays` приходит с бэкенда корректно.

---

## 5. Граничные случаи

### Кейс 1: Изменение расписания и история
**Условие:** У привычки было расписание Пн, Ср. Пользователь выполнил её в Пн. Затем изменил расписание на Вт, Чт.
**Поведение:**
- Запись выполнения за прошлый Пн остается в базе и отображается в статистике/истории.
- В будущий Пн привычка не появится.
- Если вернуться в календаре на прошлый Пн — привычка *не отобразится* в списке "План на день" (так как фильтрация идет по *текущим* настройкам), НО если она была выполнена, мы должны её показать.
- **Уточнение логики фильтрации:**
  - Показать привычку ЕСЛИ:
    - (Она запланирована на этот день по текущему расписанию)
    - ИЛИ (У неё есть запись выполнения `habit_record` на этот день).
  - *Это решит проблему "исчезновения" выполненных задач при смене графика.*

### Кейс 2: Создание привычки без дней
**Условие:** Пользователь выбрал "По дням", но отжал все кнопки дней.
**Поведение:** Кнопка "Сохранить" заблокирована или при нажатии показывается ошибка валидации "Выберите хотя бы один день".

### Кейс 3: Часовые пояса
**Условие:** Пользователь в другом часовом поясе.
**Поведение:** Сравнение дней недели должно происходить в локальном времени пользователя (клиентская логика), так как `selectedDate` на клиенте — это локальная дата.

---

## 6. Риски и митигация

### Риск 1: Конфликт формата дней недели
**Описание:** `Date.getDay()` возвращает 0 для Воскресенья. Библиотека `date-fns` (ISO) может считать 7.
**Митигация:** Явно зафиксировать маппинг в коде: 1=Понедельник ... 6=Суббота, 0=Воскресенье (стандарт JS `Date`). В БД хранить так же. При отображении UI (Пн-Вс) учитывать сдвиг.

### Риск 2: "Исчезновение" выполненных задач из прошлого
**Описание:** Если изменить расписание, старые выполненные задачи могут пропасть из просмотра дня.
**Митигация:** Реализовать логику "Показать если запланировано ИЛИ если уже выполнено".

---

## 7. Ограничения и допущения

### Ограничения
- Не поддерживаем сложные графики (2/2, раз в месяц).
- Не храним историю изменения расписания (нет Event Sourcing).

### Допущения
- Пользователь меняет расписание не часто.
- Если пользователь меняет расписание, он понимает, что "план" на прошлые дни пересчитывается по новому графику (кроме уже выполненных фактов).

---

## 8. Не входит в задачу
- Напоминания (Push Notifications) по дням недели.
- График 2/2, 3/3.

---

## 9. Следующие шаги
- [ ] Написание технических требований (Technical_Specification.md)
