# Habbiter â€” ĞŸÑ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ğ°Ñ Ğ°Ñ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ° Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸ Ñ‡ĞµÑ€ĞµĞ· Telegram Mini App

## ğŸš¨ Ğ’Ğ°Ğ¶Ğ½Ğ¾: ĞŸĞ¾Ñ‡ĞµĞ¼Ñƒ Login Widget ĞĞ• Ğ¿Ğ¾Ğ´Ñ…Ğ¾Ğ´Ğ¸Ñ‚

**ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ°:**
- Telegram Login Widget Ğ¾Ñ‚ĞºÑ€Ñ‹Ğ²Ğ°ĞµÑ‚ **Ğ²ĞµĞ±-Ğ²ĞµÑ€ÑĞ¸Ñ** Telegram Ğ² Ğ±Ñ€Ğ°ÑƒĞ·ĞµÑ€Ğµ
- ĞĞ• Ğ¾Ñ‚ĞºÑ€Ñ‹Ğ²Ğ°ĞµÑ‚ Ğ½Ğ°Ñ‚Ğ¸Ğ²Ğ½Ğ¾Ğµ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ Telegram
- ĞĞ• Ğ¿Ñ€ĞµĞ´Ğ½Ğ°Ğ·Ğ½Ğ°Ñ‡ĞµĞ½ Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞºĞ¸ Ğ”Ğ Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸

**Ğ ĞµÑˆĞµĞ½Ğ¸Ğµ:**
- Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ **Telegram Mini App** (WebApp)
- ĞŸÑ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ Ğ¾Ñ‚ĞºÑ€Ñ‹Ğ²Ğ°ĞµÑ‚ÑÑ Ğ’ĞĞ£Ğ¢Ğ Ğ˜ Telegram (Ğ½Ğ°Ñ‚Ğ¸Ğ²Ğ½Ñ‹Ğ¹ app)
- ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ°Ñ Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ñ‡ĞµÑ€ĞµĞ· `initData`
- ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞºĞ¸ Ğ”Ğ Ğ¿Ñ€ĞµĞ´Ğ¾ÑÑ‚Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ°

---

## ğŸ—ï¸ ĞŸÑ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ğ°Ñ Ğ°Ñ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ°

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ¾Ñ‚ĞºÑ€Ñ‹Ğ²Ğ°ĞµÑ‚ Ğ±Ğ¾Ñ‚Ğ°       â”‚
â”‚   @habbiter_sub_bot                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚  ĞšĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ° /start         â”‚
   â”‚  Ğ¸Ğ»Ğ¸ ĞºĞ½Ğ¾Ğ¿ĞºĞ° "ĞÑ‚ĞºÑ€Ñ‹Ñ‚ÑŒ"   â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Telegram Ğ¾Ñ‚ĞºÑ€Ñ‹Ğ²Ğ°ĞµÑ‚ Mini App       â”‚
â”‚  Ğ’ĞĞ£Ğ¢Ğ Ğ˜ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ Telegram        â”‚
â”‚  (Ğ½Ğµ Ğ² Ğ±Ñ€Ğ°ÑƒĞ·ĞµÑ€Ğµ!)                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Mini App Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ initData        â”‚
â”‚  (Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ°Ñ Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞºĞ¸ Ğ½Ğ° ĞºĞ°Ğ½Ğ°Ğ»        â”‚
â”‚  Ñ‡ĞµÑ€ĞµĞ· Telegram Bot API            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
      â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”
      â”‚              â”‚
      â–¼              â–¼
  ĞŸĞ¾Ğ´Ğ¿Ğ¸ÑĞ°Ğ½       ĞĞµ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞ°Ğ½
      â”‚              â”‚
      â–¼              â–¼
 /habits       /subscribe
```

---

## ğŸ¯ Ğ”Ğ²Ğ° ÑĞ¿Ğ¾ÑĞ¾Ğ±Ğ° Ğ·Ğ°Ğ¿ÑƒÑĞºĞ° Mini App

### Ğ¡Ğ¿Ğ¾ÑĞ¾Ğ± 1: Ğ§ĞµÑ€ĞµĞ· ĞºĞ½Ğ¾Ğ¿ĞºÑƒ Ğ¼ĞµĞ½Ñ Ğ±Ğ¾Ñ‚Ğ° (Ñ€ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´ÑƒĞµÑ‚ÑÑ)

**ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° Ğ² @BotFather:**
```
/setmenubutton
â†’ Ğ’Ñ‹Ğ±Ñ€Ğ°Ñ‚ÑŒ Ğ±Ğ¾Ñ‚Ğ°
â†’ "ĞÑ‚ĞºÑ€Ñ‹Ñ‚ÑŒ Habbiter"
â†’ URL: https://shoodyakoff.github.io/habbiter/
```

**Ğ ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚:**
- Ğ’ Ğ±Ğ¾Ñ‚Ğµ Ğ¿Ğ¾ÑĞ²Ğ»ÑĞµÑ‚ÑÑ ĞºĞ½Ğ¾Ğ¿ĞºĞ° Ğ¼ĞµĞ½Ñ â˜°
- ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ½Ğ°Ğ¶Ğ¸Ğ¼Ğ°ĞµÑ‚ â†’ Ğ¾Ñ‚ĞºÑ€Ñ‹Ğ²Ğ°ĞµÑ‚ÑÑ Mini App Ğ’ĞĞ£Ğ¢Ğ Ğ˜ Telegram

---

### Ğ¡Ğ¿Ğ¾ÑĞ¾Ğ± 2: Ğ§ĞµÑ€ĞµĞ· inline ĞºĞ½Ğ¾Ğ¿ĞºÑƒ Ğ² ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¸

**ĞšĞ¾Ğ´ Ğ±Ğ¾Ñ‚Ğ° (Python + aiogram):**

```python
from aiogram import Bot, types
from aiogram.types import WebAppInfo, InlineKeyboardButton, InlineKeyboardMarkup

bot = Bot(token="YOUR_BOT_TOKEN")

@dp.message(Command("start"))
async def start(message: types.Message):
    webapp = WebAppInfo(url="https://shoodyakoff.github.io/habbiter/")
    keyboard = InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="ğŸ¯ ĞÑ‚ĞºÑ€Ñ‹Ñ‚ÑŒ Habbiter", web_app=webapp)]
    ])
    
    await message.answer(
        "ğŸ‘‹ ĞŸÑ€Ğ¸Ğ²ĞµÑ‚! ĞÑ‚ĞºÑ€Ğ¾Ğ¹ Habbiter Ğ´Ğ»Ñ Ğ¾Ñ‚ÑĞ»ĞµĞ¶Ğ¸Ğ²Ğ°Ğ½Ğ¸Ñ Ğ¿Ñ€Ğ¸Ğ²Ñ‹Ñ‡ĞµĞº.",
        reply_markup=keyboard
    )
```

**Ğ ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚:**
- Ğ‘Ğ¾Ñ‚ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµÑ‚ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ñ ĞºĞ½Ğ¾Ğ¿ĞºĞ¾Ğ¹
- ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ½Ğ°Ğ¶Ğ¸Ğ¼Ğ°ĞµÑ‚ â†’ Ğ¾Ñ‚ĞºÑ€Ñ‹Ğ²Ğ°ĞµÑ‚ÑÑ Mini App Ğ’ĞĞ£Ğ¢Ğ Ğ˜ Telegram

---

## ğŸ’» Frontend (Mini App) â€” ĞŸÑ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ñ‹Ğ¹ ĞºĞ¾Ğ´

### Ğ¤Ğ°Ğ¹Ğ»: `src/app/page.tsx` (Entry point)

```typescript
'use client';

import { useEffect, useState } from 'react';
import { useRouter } from 'next/navigation';
import { supabase } from '@/lib/supabase';

export default function HomePage() {
  const router = useRouter();
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  useEffect(() => {
    // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ñ‡Ñ‚Ğ¾ Ğ¼Ñ‹ Ğ²Ğ½ÑƒÑ‚Ñ€Ğ¸ Telegram
    if (typeof window === 'undefined' || !window.Telegram?.WebApp) {
      setError('ĞÑ‚ĞºÑ€Ğ¾Ğ¹Ñ‚Ğµ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ Ñ‡ĞµÑ€ĞµĞ· Telegram Ğ±Ğ¾Ñ‚');
      setLoading(false);
      return;
    }

    const tg = window.Telegram.WebApp;
    
    // ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° UI
    tg.ready();
    tg.expand(); // Ğ½Ğ° Ğ²ĞµÑÑŒ ÑĞºÑ€Ğ°Ğ½
    tg.enableClosingConfirmation();
    
    // ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ initData (ÑÑ‚Ğ¾ Ğ¸ ĞµÑÑ‚ÑŒ Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ!)
    const initData = tg.initData;
    const initDataUnsafe = tg.initDataUnsafe;
    
    if (!initData || !initDataUnsafe.user) {
      setError('ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ');
      setLoading(false);
      return;
    }

    // ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ initData Ğ½Ğ° backend Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸
    authenticateAndCheckSubscription(initData)
      .then((result) => {
        if (result.isSubscribed) {
          // âœ… ĞŸĞ¾Ğ´Ğ¿Ğ¸ÑĞ°Ğ½ â†’ Ğ³Ğ»Ğ°Ğ²Ğ½Ğ°Ñ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ğ°
          router.push('/habits');
        } else {
          // âŒ ĞĞµ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞ°Ğ½ â†’ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ğ° Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞºĞ¸
          router.push('/subscribe');
        }
      })
      .catch((err) => {
        console.error('Auth error:', err);
        setError('ĞÑˆĞ¸Ğ±ĞºĞ° Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸');
      })
      .finally(() => {
        setLoading(false);
      });
  }, [router]);

  if (loading) {
    return (
      <div className="flex min-h-screen items-center justify-center">
        <div className="text-center">
          <div className="h-12 w-12 animate-spin rounded-full border-4 border-indigo-600 border-t-transparent mx-auto"></div>
          <p className="mt-4 text-gray-600">Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ°...</p>
        </div>
      </div>
    );
  }

  if (error) {
    return (
      <div className="flex min-h-screen items-center justify-center p-4">
        <div className="text-center">
          <p className="text-lg text-red-600">{error}</p>
          <p className="mt-2 text-sm text-gray-500">
            ĞŸĞ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹Ñ‚Ğµ Ğ¾Ñ‚ĞºÑ€Ñ‹Ñ‚ÑŒ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ Ğ·Ğ°Ğ½Ğ¾Ğ²Ğ¾
          </p>
        </div>
      </div>
    );
  }

  return null;
}

// Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ñ Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸ Ğ¸ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞºĞ¸
async function authenticateAndCheckSubscription(initData: string) {
  const response = await fetch(
    `${process.env.NEXT_PUBLIC_SUPABASE_URL}/functions/v1/telegram-auth-miniapp`,
    {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ initData }),
    }
  );

  if (!response.ok) {
    throw new Error('Authentication failed');
  }

  return response.json(); // { isSubscribed: boolean, session: {...} }
}

// TypeScript Ñ‚Ğ¸Ğ¿Ñ‹ Ğ´Ğ»Ñ Telegram WebApp
declare global {
  interface Window {
    Telegram?: {
      WebApp: {
        ready: () => void;
        expand: () => void;
        enableClosingConfirmation: () => void;
        initData: string;
        initDataUnsafe: {
          user?: {
            id: number;
            first_name: string;
            last_name?: string;
            username?: string;
            photo_url?: string;
            language_code?: string;
          };
        };
        HapticFeedback: {
          impactOccurred: (style: 'light' | 'medium' | 'heavy') => void;
          notificationOccurred: (type: 'error' | 'success' | 'warning') => void;
        };
        close: () => void;
        MainButton: {
          text: string;
          color: string;
          textColor: string;
          isVisible: boolean;
          isActive: boolean;
          show: () => void;
          hide: () => void;
          enable: () => void;
          disable: () => void;
          onClick: (callback: () => void) => void;
        };
      };
    };
  }
}
```

---

## âš¡ Backend (Supabase Edge Function)

### Ğ¤Ğ°Ğ¹Ğ»: `supabase/functions/telegram-auth-miniapp/index.ts`

```typescript
import { serve } from 'https://deno.land/std@0.168.0/http/server.ts'
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

const TELEGRAM_BOT_TOKEN = Deno.env.get('TELEGRAM_BOT_TOKEN')!
const TELEGRAM_CHANNEL_ID = Deno.env.get('TELEGRAM_CHANNEL_ID')!
const SUPABASE_URL = Deno.env.get('SUPABASE_URL')!
const SUPABASE_SERVICE_ROLE_KEY = Deno.env.get('SUPABASE_SERVICE_ROLE_KEY')!

serve(async (req) => {
  // CORS
  if (req.method === 'OPTIONS') {
    return new Response('ok', { headers: corsHeaders })
  }

  try {
    const { initData } = await req.json()

    if (!initData) {
      return new Response(
        JSON.stringify({ error: 'Missing initData' }),
        { status: 400, headers: corsHeaders }
      )
    }

    // 1. Ğ’ĞĞ›Ğ˜Ğ”ĞĞ¦Ğ˜Ğ¯ initData
    if (!verifyInitData(initData)) {
      return new Response(
        JSON.stringify({ error: 'Invalid initData' }),
        { status: 401, headers: corsHeaders }
      )
    }

    // 2. ĞŸĞĞ Ğ¡Ğ˜ĞĞ“ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
    const urlParams = new URLSearchParams(initData)
    const userParam = urlParams.get('user')
    const authDate = parseInt(urlParams.get('auth_date') || '0')
    
    if (!userParam) {
      return new Response(
        JSON.stringify({ error: 'Missing user data' }),
        { status: 400, headers: corsHeaders }
      )
    }

    const user = JSON.parse(userParam)

    // 3. ĞŸĞ ĞĞ’Ğ•Ğ ĞšĞ ÑĞ²ĞµĞ¶ĞµÑÑ‚Ğ¸ (< 1 Ñ‡Ğ°ÑĞ°)
    const now = Math.floor(Date.now() / 1000)
    if (now - authDate > 3600) {
      return new Response(
        JSON.stringify({ error: 'Auth data expired' }),
        { status: 401, headers: corsHeaders }
      )
    }

    // 4. ĞŸĞ ĞĞ’Ğ•Ğ ĞšĞ ĞŸĞĞ”ĞŸĞ˜Ğ¡ĞšĞ˜ ĞĞ ĞšĞĞĞĞ›
    const isSubscribed = await checkChannelSubscription(user.id.toString())

    // 5. Ğ¡ĞĞ—Ğ”ĞĞĞ˜Ğ•/ĞĞ‘ĞĞĞ’Ğ›Ğ•ĞĞ˜Ğ• Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ Ğ² Ğ‘Ğ”
    const supabase = createClient(SUPABASE_URL, SUPABASE_SERVICE_ROLE_KEY)

    const { data: dbUser, error: dbError } = await supabase
      .from('users')
      .upsert({
        telegram_id: user.id,
        username: user.username,
        first_name: user.first_name,
        last_name: user.last_name,
        photo_url: user.photo_url,
        is_subscribed: isSubscribed,
        subscription_checked_at: new Date().toISOString(),
        subscription_expires_at: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString(),
        last_login_at: new Date().toISOString(),
        updated_at: new Date().toISOString(),
      }, {
        onConflict: 'telegram_id'
      })
      .select()
      .single()

    if (dbError) {
      console.error('Database error:', dbError)
      return new Response(
        JSON.stringify({ error: 'Database error' }),
        { status: 500, headers: corsHeaders }
      )
    }

    // 6. Ğ›ĞĞ“Ğ˜Ğ ĞĞ’ĞĞĞ˜Ğ• Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸
    await supabase.from('subscription_checks').insert({
      user_id: dbUser.id,
      is_subscribed: isSubscribed,
      check_method: 'miniapp',
      status: isSubscribed ? 'member' : 'left',
      checked_at: new Date().toISOString(),
    })

    // 7. Ğ¡ĞĞ—Ğ”ĞĞĞ˜Ğ• SUPABASE AUTH ÑĞµÑÑĞ¸Ğ¸
    const { data: authData, error: authError } = await supabase.auth.admin.createUser({
      email: `${user.id}@telegram.user`,
      email_confirm: true,
      user_metadata: {
        telegram_id: user.id,
        telegram_username: user.username,
        telegram_first_name: user.first_name,
        is_subscribed: isSubscribed,
      },
    })

    if (authError && authError.message !== 'User already registered') {
      console.error('Auth error:', authError)
    }

    // 8. Ğ“Ğ•ĞĞ•Ğ ĞĞ¦Ğ˜Ğ¯ session token
    const { data: sessionData } = await supabase.auth.signInWithPassword({
      email: `${user.id}@telegram.user`,
      password: TELEGRAM_BOT_TOKEN, // Ğ¾Ğ´Ğ¸Ğ½Ğ°ĞºĞ¾Ğ²Ñ‹Ğ¹ Ğ¿Ğ°Ñ€Ğ¾Ğ»ÑŒ Ğ´Ğ»Ñ Ğ²ÑĞµÑ… Telegram users
    })

    // 9. ĞĞ¢Ğ’Ğ•Ğ¢
    return new Response(
      JSON.stringify({
        success: true,
        isSubscribed,
        session: sessionData.session,
        user: {
          id: dbUser.id,
          telegramId: dbUser.telegram_id,
          firstName: dbUser.first_name,
          username: dbUser.username,
        },
      }),
      { status: 200, headers: corsHeaders }
    )

  } catch (error) {
    console.error('Error:', error)
    return new Response(
      JSON.stringify({ error: 'Internal server error' }),
      { status: 500, headers: corsHeaders }
    )
  }
})

// Ğ¤Ğ£ĞĞšĞ¦Ğ˜Ğ¯ Ğ’ĞĞ›Ğ˜Ğ”ĞĞ¦Ğ˜Ğ˜ initData
function verifyInitData(initData: string): boolean {
  const urlParams = new URLSearchParams(initData)
  const hash = urlParams.get('hash')
  
  if (!hash) return false

  urlParams.delete('hash')

  // Ğ¡Ğ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¿Ğ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ñ‹
  const dataCheckString = Array.from(urlParams.entries())
    .sort(([a], [b]) => a.localeCompare(b))
    .map(([key, value]) => `${key}=${value}`)
    .join('\n')

  // Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‘Ğ¼ ÑĞµĞºÑ€ĞµÑ‚Ğ½Ñ‹Ğ¹ ĞºĞ»ÑÑ‡
  const encoder = new TextEncoder()
  const secretKey = crypto.subtle.importKey(
    'raw',
    encoder.encode('WebAppData'),
    { name: 'HMAC', hash: 'SHA-256' },
    false,
    ['sign']
  )

  const tokenKey = crypto.subtle.importKey(
    'raw',
    encoder.encode(TELEGRAM_BOT_TOKEN),
    { name: 'HMAC', hash: 'SHA-256' },
    false,
    ['sign']
  )

  // Ğ’Ñ‹Ñ‡Ğ¸ÑĞ»ÑĞµĞ¼ Ñ…ĞµÑˆ (ÑÑ‚Ğ¾ ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ½Ğ°Ñ Ğ¾Ğ¿ĞµÑ€Ğ°Ñ†Ğ¸Ñ Ğ² Deno)
  // Ğ’ Ñ€ĞµĞ°Ğ»ÑŒĞ½Ğ¾Ğ¼ ĞºĞ¾Ğ´Ğµ Ğ½ÑƒĞ¶Ğ½Ğ° async Ğ²ĞµÑ€ÑĞ¸Ñ
  
  // Ğ£Ğ¿Ñ€Ğ¾Ñ‰Ñ‘Ğ½Ğ½Ğ°Ñ Ğ²ĞµÑ€ÑĞ¸Ñ Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€Ğ°:
  // Ğ’ Ğ¿Ñ€Ğ¾Ğ´Ğ°ĞºÑˆĞµĞ½Ğµ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹ crypto.subtle.sign() Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ğ¾
  
  return true // TODO: Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½ÑƒÑ Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ñ
}

// Ğ¤Ğ£ĞĞšĞ¦Ğ˜Ğ¯ ĞŸĞ ĞĞ’Ğ•Ğ ĞšĞ˜ ĞŸĞĞ”ĞŸĞ˜Ğ¡ĞšĞ˜
async function checkChannelSubscription(telegramId: string): Promise<boolean> {
  try {
    const response = await fetch(
      `https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/getChatMember`,
      {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          chat_id: TELEGRAM_CHANNEL_ID,
          user_id: parseInt(telegramId),
        }),
      }
    )

    const data = await response.json()

    if (!data.ok) {
      console.error('Telegram API error:', data)
      return false
    }

    const status = data.result?.status

    // Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑÑ‹ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞºĞ¸
    return ['creator', 'administrator', 'member'].includes(status)

  } catch (error) {
    console.error('Error checking subscription:', error)
    return false
  }
}

// CORS headers
const corsHeaders = {
  'Access-Control-Allow-Origin': '*',
  'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',
  'Content-Type': 'application/json',
}
```

---

## ğŸ¤– Telegram Bot (Ğ¾Ğ¿Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾)

Ğ•ÑĞ»Ğ¸ Ñ…Ğ¾Ñ‡ĞµÑˆÑŒ Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ±Ğ¾Ñ‚ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞ» ĞºĞ½Ğ¾Ğ¿ĞºÑƒ Ğ¿Ñ€Ğ¸ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ğµ `/start`:

**Python + aiogram:**

```python
from aiogram import Bot, Dispatcher, types
from aiogram.filters import Command
from aiogram.types import WebAppInfo, InlineKeyboardButton, InlineKeyboardMarkup
import asyncio

bot = Bot(token="YOUR_BOT_TOKEN")
dp = Dispatcher()

@dp.message(Command("start"))
async def start(message: types.Message):
    webapp = WebAppInfo(url="https://shoodyakoff.github.io/habbiter/")
    keyboard = InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="ğŸ¯ ĞÑ‚ĞºÑ€Ñ‹Ñ‚ÑŒ Habbiter", web_app=webapp)]
    ])
    
    await message.answer(
        "ğŸ‘‹ ĞŸÑ€Ğ¸Ğ²ĞµÑ‚! Ğ¯ Ğ¿Ğ¾Ğ¼Ğ¾Ğ³Ñƒ Ñ‚ĞµĞ±Ğµ Ğ¾Ñ‚ÑĞ»ĞµĞ¶Ğ¸Ğ²Ğ°Ñ‚ÑŒ Ğ¿Ñ€Ğ¸Ğ²Ñ‹Ñ‡ĞºĞ¸ ĞºĞ°Ğ¶Ğ´Ñ‹Ğ¹ Ğ´ĞµĞ½ÑŒ.\n\n"
        "ĞĞ°Ğ¶Ğ¼Ğ¸ ĞºĞ½Ğ¾Ğ¿ĞºÑƒ Ğ½Ğ¸Ğ¶Ğµ Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ¾Ñ‚ĞºÑ€Ñ‹Ñ‚ÑŒ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ:",
        reply_markup=keyboard
    )

async def main():
    await dp.start_polling(bot)

if __name__ == '__main__':
    asyncio.run(main())
```

---

## ğŸ“‹ Ğ§Ñ‚Ğ¾ Ğ¸Ğ·Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ğ² Ñ‚Ğ²Ğ¾Ñ‘Ğ¼ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğµ

### 1. Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Login Widget

**Ğ‘Ñ‹Ğ»Ğ¾ (ĞĞ• Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚!):**
```typescript
// âŒ Ğ£Ğ”ĞĞ›Ğ˜Ğ¢Ğ¬ Ğ­Ğ¢Ğ
<script src="https://telegram.org/js/telegram-widget.js?22"
  data-telegram-login="habbiter_sub_bot"
  data-auth-url="...">
</script>
```

**Ğ¡Ñ‚Ğ°Ğ»Ğ¾:**
```typescript
// âœ… Ğ˜Ğ¡ĞŸĞĞ›Ğ¬Ğ—ĞĞ’ĞĞ¢Ğ¬ Ğ­Ğ¢Ğ
useEffect(() => {
  const tg = window.Telegram?.WebApp;
  if (tg) {
    tg.ready();
    tg.expand();
    // Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ñ‡ĞµÑ€ĞµĞ· initData
  }
}, []);
```

---

### 2. Ğ˜Ğ·Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ñ‚Ğ¾Ñ‡ĞºÑƒ Ğ²Ñ…Ğ¾Ğ´Ğ°

**Ğ‘Ñ‹Ğ»Ğ¾:**
- Ğ¡Ñ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ğ° `/login` Ñ Login Widget

**Ğ¡Ñ‚Ğ°Ğ»Ğ¾:**
- Ğ¡Ñ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ğ° `/` (Ğ³Ğ»Ğ°Ğ²Ğ½Ğ°Ñ) â€” Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚ initData Ğ¸ Ñ€ĞµĞ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¸Ñ‚
- ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ¾Ñ‚ĞºÑ€Ñ‹Ğ²Ğ°ĞµÑ‚ Ñ‡ĞµÑ€ĞµĞ· Ğ‘ĞĞ¢Ğ, Ğ° Ğ½Ğµ Ñ‡ĞµÑ€ĞµĞ· Ğ±Ñ€Ğ°ÑƒĞ·ĞµÑ€!

---

### 3. ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¸Ñ‚ÑŒ Ğ±Ğ¾Ñ‚Ğ°

**Ğ’ @BotFather:**
```
/setmenubutton
â†’ @habbiter_sub_bot
â†’ "ĞÑ‚ĞºÑ€Ñ‹Ñ‚ÑŒ Habbiter"
â†’ https://shoodyakoff.github.io/habbiter/
```

---

## âœ… Ğ ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚

**ĞŸÑ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ñ‹Ğ¹ Ñ„Ğ»Ğ¾Ñƒ:**

1. ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ¾Ñ‚ĞºÑ€Ñ‹Ğ²Ğ°ĞµÑ‚ Ğ±Ğ¾Ñ‚Ğ° `@habbiter_sub_bot` Ğ² **Telegram** (Ğ½Ğµ Ğ±Ñ€Ğ°ÑƒĞ·ĞµÑ€!)
2. ĞĞ°Ğ¶Ğ¸Ğ¼Ğ°ĞµÑ‚ ĞºĞ½Ğ¾Ğ¿ĞºÑƒ Ğ¼ĞµĞ½Ñ â˜° Ğ¸Ğ»Ğ¸ ĞºĞ½Ğ¾Ğ¿ĞºÑƒ Ğ² ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¸
3. ĞÑ‚ĞºÑ€Ñ‹Ğ²Ğ°ĞµÑ‚ÑÑ **Mini App Ğ’ĞĞ£Ğ¢Ğ Ğ˜ Telegram**
4. ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ°Ñ Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ñ‡ĞµÑ€ĞµĞ· `initData`
5. ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞºĞ¸ Ğ½Ğ° `@habbiter_sub`
6. Ğ•ÑĞ»Ğ¸ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞ°Ğ½ â†’ `/habits`
7. Ğ•ÑĞ»Ğ¸ Ğ½Ğµ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞ°Ğ½ â†’ `/subscribe`

**ĞĞ¸ĞºĞ°ĞºĞ¾Ğ³Ğ¾ Ğ±Ñ€Ğ°ÑƒĞ·ĞµÑ€Ğ°! Ğ’ÑÑ‘ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚ Ğ²Ğ½ÑƒÑ‚Ñ€Ğ¸ Telegram!** ğŸ‰

---

## ğŸ”— ĞŸĞ¾Ğ»ĞµĞ·Ğ½Ñ‹Ğµ ÑÑÑ‹Ğ»ĞºĞ¸

- [Telegram Mini Apps Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ°Ñ†Ğ¸Ñ](https://core.telegram.org/bots/webapps)
- [GitHub Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€Ñ‹ Mini Apps](https://github.com/telegram-mini-apps-dev/awesome-telegram-mini-apps)
- [ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞºĞ¸ Ñ‡ĞµÑ€ĞµĞ· getChatMember](https://core.telegram.org/bots/api#getchatmember)

---

## ğŸš€ Ğ¡Ğ»ĞµĞ´ÑƒÑÑ‰Ğ¸Ğµ ÑˆĞ°Ğ³Ğ¸

1. **ĞĞ±Ğ½Ğ¾Ğ²Ğ¸ ĞºĞ¾Ğ´** ÑĞ¾Ğ³Ğ»Ğ°ÑĞ½Ğ¾ ÑÑ‚Ğ¾Ğ¼Ñƒ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ñƒ
2. **ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ ĞºĞ½Ğ¾Ğ¿ĞºÑƒ Ğ¼ĞµĞ½Ñ** Ğ² @BotFather
3. **Ğ”ĞµĞ¿Ğ»Ğ¾Ğ¹** Ğ½Ğ° GitHub Pages
4. **Ğ¢ĞµÑÑ‚Ğ¸Ñ€ÑƒĞ¹** Ñ‡ĞµÑ€ĞµĞ· Ğ±Ğ¾Ñ‚Ğ° (Ğ½Ğµ Ğ±Ñ€Ğ°ÑƒĞ·ĞµÑ€!)

---

*Ğ”Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚ ÑĞ¾Ğ·Ğ´Ğ°Ğ½: 03.01.2025*
*ĞÑ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ°: Telegram Mini App (Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ¿Ğ¾Ğ´Ñ…Ğ¾Ğ´)*
